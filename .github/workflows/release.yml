name: Release CLI (test)

on:
    workflow_dispatch:
        inputs:
            publish_release:
                description: "Publish / update the test prerelease (v0.0.0-test)"
                type: boolean
                required: false
                default: true

    push:
        branches:
            - feature/pipelines

concurrency:
    group: release-test
    cancel-in-progress: true

jobs:
    build-linux:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - run: bun install

            - name: Build Linux
              run: |
                  set -euo pipefail
                  mkdir -p dist/bin dist/archives

                  bun build src/cli.ts --compile --target=bun-linux-x64   --outfile=dist/bin/ek
                  tar -czf dist/archives/enkryptify_Linux_x86_64.tar.gz -C dist/bin ek

                  bun build src/cli.ts --compile --target=bun-linux-arm64 --outfile=dist/bin/ek
                  tar -czf dist/archives/enkryptify_Linux_arm64.tar.gz  -C dist/bin ek

                  sha256sum dist/archives/*.tar.gz > dist/archives/checksums.txt

            - uses: actions/upload-artifact@v4
              with:
                  name: linux
                  path: dist/archives/*

    build-macos:
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - run: bun install

            - name: Build macOS
              run: |
                  set -euo pipefail
                  mkdir -p dist/bin dist/archives

                  # Build binaries
                  bun build src/cli.ts --compile --target=bun-darwin-x64   --outfile=dist/bin/ek
                  bun build src/cli.ts --compile --target=bun-darwin-arm64 --outfile=dist/bin/ek

                  # âœ… COPY COMPLETION FILES
                  cp src/complete/ek.bash dist/bin/
                  cp src/complete/ek.zsh  dist/bin/
                  cp src/complete/ek.ps1  dist/bin/

                  # Package
                  tar -czf dist/archives/enkryptify_Darwin_x86_64.tar.gz -C dist/bin ek ek.bash ek.zsh ek.ps1
                  tar -czf dist/archives/enkryptify_Darwin_arm64.tar.gz  -C dist/bin ek ek.bash ek.zsh ek.ps1

                  shasum -a 256 dist/archives/*.tar.gz > dist/archives/checksums.txt

            - uses: actions/upload-artifact@v4
              with:
                  name: macos
                  path: dist/archives/*

    publish:
        needs: [build-linux, build-macos]
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: actions/download-artifact@v4
              with:
                  path: dist/archives
                  merge-multiple: true

            - name: Create combined checksums
              run: |
                  cd dist/archives
                  rm -f checksums.txt
                  sha256sum *.tar.gz > checksums.txt || shasum -a 256 *.tar.gz > checksums.txt

            - name: Move test tag
              if: ${{ github.event_name == 'push' || inputs.publish_release }}
              run: |
                  git config user.name  "Enkryptify Bot"
                  git config user.email "bot@enkryptify.com"
                  git tag -f v0.0.0-test
                  git push -f origin v0.0.0-test

            - name: Publish GitHub prerelease
              if: ${{ github.event_name == 'push' || inputs.publish_release }}
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v0.0.0-test
                  prerelease: true
                  overwrite_files: true
                  files: dist/archives/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Update Homebrew test tap
              if: ${{ github.event_name == 'push' || inputs.publish_release }}
              env:
                  TAP_TOKEN: ${{ secrets.GH_TOKEN }}
              run: |
                  set -euo pipefail

                  git clone https://x-access-token:${TAP_TOKEN}@github.com/Enkryptify/homebrew-enkryptify-test.git
                  cd homebrew-enkryptify-test

                  git config user.name  "Enkryptify Bot"
                  git config user.email "bot@enkryptify.com"

                  ARM_SHA=$(grep enkryptify_Darwin_arm64.tar.gz ../dist/archives/checksums.txt | awk '{print $1}')
                  X64_SHA=$(grep enkryptify_Darwin_x86_64.tar.gz ../dist/archives/checksums.txt | awk '{print $1}')

                  cat > Formula/enkryptify.rb <<EOF
                  class Enkryptify < Formula
                    desc "Enkryptify CLI (test)"
                    homepage "https://enkryptify.com"
                    version "0.0.0-test"

                    on_macos do
                      if Hardware::CPU.arm?
                        url "https://github.com/Enkryptify/cli/releases/download/v0.0.0-test/enkryptify_Darwin_arm64.tar.gz"
                        sha256 "${ARM_SHA}"
                      else
                        url "https://github.com/Enkryptify/cli/releases/download/v0.0.0-test/enkryptify_Darwin_x86_64.tar.gz"
                        sha256 "${X64_SHA}"
                      end
                    end

                    def install
                      bin.install "ek"
                      bash_completion.install "ek.bash" => "ek"
                      zsh_completion.install "ek.zsh" => "_ek"
                      pkgshare.install "ek.ps1"
                    end

                    test do
                      system "#{bin}/ek", "--help"
                    end
                  end
                  EOF

                  git add Formula/enkryptify.rb
                  git commit -m "Update test formula v0.0.0-test"
                  git push
