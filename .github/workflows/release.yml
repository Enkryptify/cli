name: Release CLI (macOS test)

on:
    workflow_dispatch:
        inputs:
            publish_release:
                description: "Publish / update the test prerelease (v0.0.0-test)"
                type: boolean
                required: false
                default: true

    push:
        branches:
            - feature/pipelines

concurrency:
    group: release-test-macos
    cancel-in-progress: true

jobs:
    build-and-release-macos:
        runs-on: macos-latest
        permissions:
            contents: write

        steps:
            - name: Checkout (full history for tagging)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install deps
              run: bun install

            - name: Build macOS binaries (x64 + arm64)
              shell: bash
              run: |
                  set -euo pipefail
                  mkdir -p dist/bin dist/archives

                  bun build src/cli.ts \
                    --compile \
                    --target=bun-darwin-x64 \
                    --outfile=dist/bin/ek-darwin-x64 \
                    --define:API_BASE_URL_DEFAULT='"https://api.enkryptify.com"' \
                    --define:APP_BASE_URL_DEFAULT='"https://app.enkryptify.com"' \
                    --define:CLI_VERSION_DEFAULT='"0.2.0-alpha.1"' \
                    --define:GCP_AUTH_URL_DEFAULT='"https://www.googleapis.com/auth/cloud-platform"' \
                    --define:GCP_AUTH_SCOPES='"https://www.googleapis.com/auth/cloud-platform"'

                  bun build src/cli.ts \
                    --compile \
                    --target=bun-darwin-arm64 \
                    --outfile=dist/bin/ek-darwin-arm64 \
                    --define:API_BASE_URL_DEFAULT='"https://api.enkryptify.com"' \
                    --define:APP_BASE_URL_DEFAULT='"https://app.enkryptify.com"' \
                    --define:CLI_VERSION_DEFAULT='"0.2.0-alpha.1"' \
                    --define:GCP_AUTH_URL_DEFAULT='"https://www.googleapis.com/auth/cloud-platform"' \
                    --define:GCP_AUTH_SCOPES='"https://www.googleapis.com/auth/cloud-platform"'

                  tar -czf dist/archives/enkryptify_Darwin_x86_64.tar.gz -C dist/bin ek-darwin-x64
                  tar -czf dist/archives/enkryptify_Darwin_arm64.tar.gz  -C dist/bin ek-darwin-arm64

                  (cd dist/archives && shasum -a 256 * > checksums.txt)

            - name: Move tag v0.0.0-test to this commit
              if: ${{ github.event_name == 'push' || inputs.publish_release }}
              shell: bash
              run: |
                  set -euo pipefail
                  git config user.name  "Enkryptify Bot"
                  git config user.email "bot@enkryptify.com"
                  git tag -f v0.0.0-test
                  git push -f origin v0.0.0-test

            - name: Publish / update GitHub prerelease (v0.0.0-test)
              if: ${{ github.event_name == 'push' || inputs.publish_release }}
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v0.0.0-test
                  name: Test Release v0.0.0-test
                  prerelease: true
                  overwrite_files: true
                  files: |
                      dist/archives/*
                  body: |
                      ⚠️ Test prerelease from branch `release-test`
                      Commit: ${{ github.sha }}

                      ## macOS (Apple Silicon)
                      tar -xzf enkryptify_Darwin_arm64.tar.gz
                      chmod +x ek-darwin-arm64
                      xattr -dr com.apple.quarantine ek-darwin-arm64 || true
                      ./ek-darwin-arm64 --help

                      ## macOS (Intel)
                      tar -xzf enkryptify_Darwin_x86_64.tar.gz
                      chmod +x ek-darwin-x64
                      xattr -dr com.apple.quarantine ek-darwin-x64 || true
                      ./ek-darwin-x64 --help
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
