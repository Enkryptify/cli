name: Release CLI (test)

on:
    workflow_dispatch:
    push:
        tags:
            - "v*-test.*"

permissions:
    contents: write

jobs:
    release:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - run: bun install

            - name: Build binaries (Bun)
              run: |
                  set -euo pipefail
                  mkdir -p dist/bin

                  # Linux
                  bun build src/cli.ts --compile --target=bun-linux-x64   --outfile=dist/bin/ek
                  bun build src/cli.ts --compile --target=bun-linux-arm64 --outfile=dist/bin/ek

                  # macOS
                  bun build src/cli.ts --compile --target=bun-darwin-x64   --outfile=dist/bin/ek
                  bun build src/cli.ts --compile --target=bun-darwin-arm64 --outfile=dist/bin/ek

                  # Windows
                  bun build src/cli.ts --compile --target=bun-windows-x64 --outfile=dist/bin/ek.exe
                  mkdir -p dist/bin/enkryptify-completion
                  cp src/complete/enkryptify-completion.psm1 dist/bin/enkryptify-completion/

                  # Shell completions
                  cp src/complete/ek.bash dist/bin/
                  cp src/complete/ek.zsh  dist/bin/

            - name: Run GoReleaser
              uses: goreleaser/goreleaser-action@v5
              with:
                  version: latest
                  args: release --clean
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
