name: Release CLI (macOS test)

on:
    workflow_dispatch:
        inputs:
            publish_release:
                description: "Publish / update the test prerelease (v0.0.0-test)"
                type: boolean
                required: false
                default: true

    push:
        branches:
            - 1password/integration

concurrency:
    group: release-test-macos
    cancel-in-progress: true

jobs:
    build-and-release-macos:
        runs-on: macos-latest
        permissions:
            contents: write

        steps:
            - name: Checkout (full history for tagging)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install deps
              run: bun install --ignore-scripts

            - name: Patch 1Password SDK for bundling
              shell: bash
              run: |
                  echo "üîß Patching 1Password SDK..."
                  bun run scripts/patch-1password.ts

                  echo ""
                  echo "Verifying patch..."
                  if grep -q "ENKRYPTIFY BUNDLING PATCH" node_modules/@1password/sdk-core/nodejs/index.js; then
                    echo "‚úÖ SDK successfully patched"
                  else
                    echo "‚ùå SDK patch verification failed"
                    exit 1
                  fi

            - name: Build macOS binaries (x64 + arm64)
              shell: bash
              run: |
                  set -euo pipefail
                  mkdir -p dist/bin dist/archives

                  bun build src/cli.ts \
                    --compile \
                    --minify-whitespace \
                    --compile-autoload-tsconfig \
                    --compile-autoload-package-json \
                    --target=bun-darwin-x64 \
                    --outfile=dist/bin/ek-darwin-x64

                  bun build src/cli.ts \
                    --compile \
                    --minify-whitespace \
                    --compile-autoload-tsconfig \
                    --compile-autoload-package-json \
                    --target=bun-darwin-arm64 \
                    --outfile=dist/bin/ek-darwin-arm64

                  # Copy WASM file needed by 1Password SDK
                  if [ -f "node_modules/@1password/sdk-core/nodejs/core_bg.wasm" ]; then
                    cp node_modules/@1password/sdk-core/nodejs/core_bg.wasm dist/bin/
                    echo "‚úÖ Copied 1Password WASM file"
                  else
                    echo "‚ùå ERROR: 1Password WASM file not found!"
                    exit 1
                  fi

                  # Create archives with binary and WASM file
                  tar -czf dist/archives/enkryptify_Darwin_x86_64.tar.gz -C dist/bin ek-darwin-x64 core_bg.wasm
                  tar -czf dist/archives/enkryptify_Darwin_arm64.tar.gz  -C dist/bin ek-darwin-arm64 core_bg.wasm

                  # Generate checksums
                  (cd dist/archives && shasum -a 256 * > checksums.txt)

                  # Show what we built
                  echo ""
                  echo "üì¶ Built artifacts:"
                  ls -lh dist/archives/
                  echo ""
                  echo "Archive contents:"
                  tar -tzf dist/archives/enkryptify_Darwin_arm64.tar.gz

            - name: Move tag v0.0.0-test to this commit
              if: ${{ github.event_name == 'push' || inputs.publish_release }}
              shell: bash
              run: |
                  set -euo pipefail
                  git config user.name  "Enkryptify Bot"
                  git config user.email "bot@enkryptify.com"
                  git tag -f v0.0.0-test
                  git push -f origin v0.0.0-test

            - name: Publish / update GitHub prerelease (v0.0.0-test)
              if: ${{ github.event_name == 'push' || inputs.publish_release }}
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v0.0.0-test
                  name: Test Release v0.0.0-test
                  prerelease: true
                  overwrite_files: true
                  files: |
                      dist/archives/*
                  body: |
                      ‚ö†Ô∏è Test prerelease from branch `1password/integration`
                      Commit: ${{ github.sha }}

                      ## Installation & Usage

                      ### macOS (Apple Silicon - M1/M2/M3)
                      ```bash
                      # Download and extract
                      curl -L -O https://github.com/${{ github.repository }}/releases/download/v0.0.0-test/enkryptify_Darwin_arm64.tar.gz
                      tar -xzf enkryptify_Darwin_arm64.tar.gz

                      # Make executable and remove quarantine
                      chmod +x ek-darwin-arm64
                      xattr -dr com.apple.quarantine ek-darwin-arm64 || true

                      # Run (ensure core_bg.wasm is in the same directory)
                      ./ek-darwin-arm64 --help
                      ```

                      ### macOS (Intel)
                      ```bash
                      # Download and extract
                      curl -L -O https://github.com/${{ github.repository }}/releases/download/v0.0.0-test/enkryptify_Darwin_x86_64.tar.gz
                      tar -xzf enkryptify_Darwin_x86_64.tar.gz

                      # Make executable and remove quarantine
                      chmod +x ek-darwin-x64
                      xattr -dr com.apple.quarantine ek-darwin-x64 || true

                      # Run (ensure core_bg.wasm is in the same directory)
                      ./ek-darwin-x64 --help
                      ```

                      ‚ö†Ô∏è **Important**: Both the executable and `core_bg.wasm` must be in the same directory for the CLI to work.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
